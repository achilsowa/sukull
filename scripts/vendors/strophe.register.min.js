Strophe.addConnectionPlugin("register",{_connection:null,init:function(e){this._connection=e;var c=0;Object.keys(Strophe.Status).forEach(function(g){c=Math.max(c,Strophe.Status[g])});Strophe.addNamespace("REGISTER","jabber:iq:register");Strophe.Status.REGIFAIL=c+1;Strophe.Status.REGISTER=c+2;Strophe.Status.REGISTERED=c+3;Strophe.Status.CONFLICT=c+4;Strophe.Status.NOTACCEPTABLE=c+5;if(e.disco){if(e.disco.addFeature){e.disco.addFeature(Strophe.NS.REGISTER)}if(e.disco.addNode){e.disco.addNode(Strophe.NS.REGISTER,{items:[]})}}var a=this,d=e.reset.bind(e);e.reset=function(){d();a.instructions="";a.fields={};a.registered=false};var f=e._connect_cb.bind(e);e._connect_cb=function(i,k,h){if(!a._registering){if(a.processed_features){var j=e.xmlInput;e.xmlInput=Strophe.Connection.prototype.xmlInput;var g=e.rawInput;e.rawInput=Strophe.Connection.prototype.rawInput;f(i,k,h);e.xmlInput=j;e.rawInput=g;delete a.processed_features}else{f(i,k,h)}}else{a._connect_cb_data={req:i,raw:h};if(a._register_cb(i,k,h)){a.processed_features=true;delete a._registering}}};var b=e.authenticate.bind(e);e.authenticate=function(g){if(typeof g==="undefined"){var k=this._connection;if(!this.fields.username||!this.domain||!this.fields.password){Strophe.info("Register a JID first!");return}var i=this.fields.username+"@"+this.domain;k.jid=i;k.authzid=Strophe.getBareJidFromJid(k.jid);k.authcid=Strophe.getNodeFromJid(k.jid);k.pass=this.fields.password;var j=this._connect_cb_data.req;var l=k.connect_callback;var h=this._connect_cb_data.raw;k._connect_cb(j,l,h)}else{b(g)}}.bind(this)},connect:function(c,f,e,d,a){var b=this._connection;this.domain=Strophe.getDomainFromJid(c);this.instructions="";this.fields={};this.registered=false;this._registering=true;b.connect(this.domain,"",f,e,d,a)},_register_cb:function(h,a,c){var g=this._connection;Strophe.info("_register_cb was called");g.connected=true;var d=g._proto._reqToData(h);if(!d){return}if(g.xmlInput!==Strophe.Connection.prototype.xmlInput){if(d.nodeName===g._proto.strip&&d.childNodes.length){g.xmlInput(d.childNodes[0])}else{g.xmlInput(d)}}if(g.rawInput!==Strophe.Connection.prototype.rawInput){if(c){g.rawInput(c)}else{g.rawInput(Strophe.serialize(d))}}var f=g._proto._connect_cb(d);if(f===Strophe.Status.CONNFAIL){return false}var e=d.getElementsByTagName("register");var b=d.getElementsByTagName("mechanism");if(e.length===0&&b.length===0){g._proto._no_auth_received(a);return false}if(e.length===0){g._changeConnectStatus(Strophe.Status.REGIFAIL,null);return true}g._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null);g.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree());return true},_get_register_cb:function(e){var a,c,d,b=this._connection;c=e.getElementsByTagName("query");if(c.length!==1){b._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown");return false}c=c[0];for(a=0;a<c.childNodes.length;a++){d=c.childNodes[a];if(d.tagName.toLowerCase()==="instructions"){b.register.instructions=Strophe.getText(d);continue}else{if(d.tagName.toLowerCase()==="x"){continue}}b.register.fields[d.tagName.toLowerCase()]=Strophe.getText(d)}b._changeConnectStatus(Strophe.Status.REGISTER,null);return false},submit:function(){var c,b,e,a,d=this._connection;e=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.REGISTER});a=Object.keys(this.fields);for(c=0;c<a.length;c++){b=a[c];e.c(b).t(this.fields[b]).up()}d._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null);d.send(e)},_submit_cb:function(f){var b,d,e,a=null,c=this._connection;d=f.getElementsByTagName("query");if(d.length>0){d=d[0];for(b=0;b<d.childNodes.length;b++){e=d.childNodes[b];if(e.tagName.toLowerCase()==="instructions"){this.instructions=Strophe.getText(e);continue}this.fields[e.tagName.toLowerCase()]=Strophe.getText(e)}}if(f.getAttribute("type")==="error"){a=f.getElementsByTagName("error");if(a.length!==1){c._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown");return false}Strophe.info("Registration failed.");a=a[0].firstChild.tagName.toLowerCase();if(a==="conflict"){c._changeConnectStatus(Strophe.Status.CONFLICT,a)}else{if(a==="not-acceptable"){c._changeConnectStatus(Strophe.Status.NOTACCEPTABLE,a)}else{c._changeConnectStatus(Strophe.Status.REGIFAIL,a)}}}Strophe.info("Registered successful.");c._changeConnectStatus(Strophe.Status.REGISTERED,null);return false}});